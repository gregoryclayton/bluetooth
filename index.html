<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bluetooth Scan Plotter</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #log { white-space: pre; background: #f5f5f5; padding: 0.5rem; height: 200px; overflow: auto; }
    #canvas { border: 1px solid #ccc; background: #fafafa; }
    button { margin: 0.25rem 0; }
  </style>
</head>
<body>
  <h1>Bluetooth Scan Plotter</h1>
  <p><strong>Requires HTTPS/localhost. Multi-device scanning requires Chrome with “Experimental Web Platform features” enabled.</strong></p>
  <p>
    <button id="initGeo">Get Initial Location</button>
    <button id="scanBt" disabled>Scan Bluetooth (discover all)</button>
    <button id="stopScan" disabled>Stop Scan</button>
    <button id="singleSelect" disabled>Single Device Scan</button>
  </p>
  <canvas id="canvas" width="500" height="300"></canvas>
  <h3>Log</h3>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const initGeoBtn = document.getElementById('initGeo');
    const scanBtn = document.getElementById('scanBt');
    const stopBtn = document.getElementById('stopScan');
    const singleSelectBtn = document.getElementById('singleSelect');

    let origin = null; // { lat, lon }
    const sightings = []; // { key, name, dx, dy, lat, lon, timestamp }
    let activeScan = null;

    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function setOrigin(pos) {
      origin = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      log(`Origin set at lat=${origin.lat.toFixed(6)}, lon=${origin.lon.toFixed(6)}`);
      scanBtn.disabled = false;
      singleSelectBtn.disabled = false;
      draw();
    }

    function toMetersOffset(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const x = dLon * Math.cos((lat1 + lat2) * Math.PI / 360) * R;
      const y = dLat * R;
      return { x, y };
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#ccc';
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();

      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(canvas.width / 2, canvas.height / 2, 5, 0, 2 * Math.PI);
      ctx.fill();
      ctx.fillText('Origin', canvas.width / 2 + 8, canvas.height / 2 - 8);

      ctx.fillStyle = 'blue';
      const scale = 0.5;
      for (const s of sightings) {
        const x = canvas.width / 2 + s.dx * scale;
        const y = canvas.height / 2 - s.dy * scale;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillText(s.name, x + 6, y - 6);
      }
    }

    function recordSighting(name, key) {
      if (!origin) {
        log('Origin not set; cannot log.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          const { x, y } = toMetersOffset(origin.lat, origin.lon, latitude, longitude);
          const sighting = { key, name, dx: x, dy: y, lat: latitude, lon: longitude, timestamp: Date.now() };
          sightings.push(sighting);
          log(`Plotted ${name} at dx=${x.toFixed(1)}m, dy=${y.toFixed(1)}m`);
          draw();
        },
        (err) => log(`Geolocation error: ${err.message}`),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // Set origin
    initGeoBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return log('Geolocation not supported.');
      navigator.geolocation.getCurrentPosition(
        setOrigin,
        (err) => log(`Geolocation error: ${err.message}`),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });

    // Full scan (experimental)
    scanBtn.addEventListener('click', async () => {
      if (!origin) return log('Set origin first.');
      if (!navigator.bluetooth || !navigator.bluetooth.requestLEScan) {
        log('Scanning API not supported; use Single Device (chooser) or enable experimental flag.');
        return;
      }
      try {
        activeScan = await navigator.bluetooth.requestLEScan({
          acceptAllAdvertisements: true,
          keepRepeatedDevices: false
        });
        scanBtn.disabled = true;
        stopBtn.disabled = false;
        log('Scan started (experimental API)...');

        navigator.bluetooth.addEventListener('advertisementreceived', (event) => {
          const name = event.device.name || '(no name)';
          const key = event.device.id || `${name}-${event.manufacturerData?.size || 0}`;
          if (sightings.some(s => s.key === key)) return;
          recordSighting(name, key);
        });
      } catch (err) {
        log(`Scan failed: ${err.message}`);
      }
    });

    stopBtn.addEventListener('click', () => {
      if (activeScan && activeScan.active) activeScan.stop();
      activeScan = null;
      scanBtn.disabled = false;
      stopBtn.disabled = true;
      log('Scan stopped.');
    });

    // “Single Device Scan” button:
    // If scanning API is available, use it to plot every device (first sighting).
    // Else, fall back to chooser (one per click).
    singleSelectBtn.addEventListener('click', async () => {
      if (!origin) return log('Set origin first.');
      if (!navigator.bluetooth) return log('Web Bluetooth not supported.');
      // Prefer scanning if available
      if (navigator.bluetooth.requestLEScan) {
        try {
          const scan = await navigator.bluetooth.requestLEScan({
            acceptAllAdvertisements: true,
            keepRepeatedDevices: false
          });
          log('Single-device button using scan: plotting each device seen (experimental API)...');
          const onAdv = (event) => {
            const name = event.device.name || '(no name)';
            const key = event.device.id || `${name}-${event.manufacturerData?.size || 0}`;
            if (sightings.some(s => s.key === key)) return;
            recordSighting(name, key);
          };
          navigator.bluetooth.addEventListener('advertisementreceived', onAdv);
          // Stop after 10 seconds for this “single” scan
          setTimeout(() => {
            if (scan.active) scan.stop();
            navigator.bluetooth.removeEventListener('advertisementreceived', onAdv);
            log('Single-device scan (using scanning API) stopped.');
          }, 10000);
        } catch (err) {
          log(`Scan failed: ${err.message}`);
        }
        return;
      }

      // Fallback: chooser (one device per click)
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: []
        });
        const name = device.name || '(no name)';
        recordSighting(name, device.id);
      } catch (err) {
        log(`Bluetooth request failed: ${err.message}`);
      }
    });
  </script>
</body>
</html>
